const yoKaiList = [
{ name: "Dulluma", img: "tentelento.png" },
{ name: "Darumacho", img: "tentemacho.png" },
{ name: "Goruma", img: "tenterila.png" },
{ name: "Noway", img: "nihablar.png" },
{ name: "Impass", img: "impas.png" },
{ name: "Walldin", img: "murallin.png" },
{ name: "Armsman", img: "lorigon.png" },
{ name: "Fidgephant", img: "inquielifante.png" },
{ name: "Toughant", img: "perselefante.png" },
{ name: "Blowkade", img: "globqueo.png" },
{ name: "Ledballoon", img: "globtundente.png" },
{ name: "Mad Mountain", img: "montaña_loca.png" },
{ name: "Lava Lord", img: "lord_lava.png" },
{ name: "Roughraff", img: "rebelcebu.png" },
{ name: "Badude", img: "caporrista.png" },
{ name: "Bruff", img: "hermanion.png" },
{ name: "Rhinnogin", img: "pegarabajo.png" },
{ name: "Rhinormous", img: "enormarabajo.png" },
{ name: "Hornaplenty", img: "cuernarabajo.png" },
{ name: "Castelius III", img: "castelius_III.png" },
{ name: "Castelius II", img: "castelius_II.png" },
{ name: "Castelius I", img: "Castelius_I.png" },
{ name: "Castelius Max", img: "Maxicastelius.png" },
{ name: "Robonyan", img: "robonyan.png" },
{ name: "Goldenyan", img: "aureonyan.png" },
{ name: "Dromp", img: "pom.png" },
{ name: "Swosh", img: "flus.png" },
{ name: "Gilgaros", img: "dorantuo.png" },
    { name: "Terrorpotta", img: "Aterracota.png" },
    { name: "Wotchagot", img: "Quierodeso.png" },
    { name: "Pride Shrimp", img: "Gambulloso.png" },
    { name: "No-Go Kart", img: "Indiligencio.png" },
    { name: "Mistank", img: "Tanquivocado.png" },
    { name: "Mimikin", img: "Mimoniqui.png" },
    { name: "Enduriphant", img: "Mamuguanto.png" },
    { name: "Zappary", img: "Rayael.png" },
    { name: "Frazzel", img: "Cazarrayos.png" },
    { name: "Swelton", img: "Zudado.png" },
    { name: "Toadal Dude", img: "Eleganfibio.png" },
    { name: "Uber Geeko", img: "Frikigarto.png" },
    { name: "Robonyan F", img: "Robonyan_2.0.png" },
    { name: "Sumodon", img: "Sumodon.png" },
    { name: "Yokuzodon", img: "Supersumodon.png" },
    { name: "Whateverest", img: "Desinverest.png" },
    { name: "Whatuption", img: "Inverestupcion.png" },
    { name: "Gargaros", img: "Gargantuo_A.png" },
    { name: "Ogralus", img: "Cazamentires_A.png" },
    { name: "Orcanos", img: "Demoniorco_A.png" },
  { "name": "Puppynyan", "img": "Perronyan.png" },
  { "name": "Kintaronyan", "img": "Kintaronyan.png" },
  { "name": "Kabuking", "img": "Kabukio_A.png" },
  { "name": "Oh Wheel", "img": "Prudencio.png" },
  { "name": "Blownhistoppa", "img": "Explotacota.png" },
  { "name": "Roughgraff", "img": "Grafilcebu.png" },
  { "name": "Chilled Cowcao", "img": "Chocovaca.png" },
  { "name": "Stircrazy Stu", "img": "Vacaloca.png" },
  { "name": "Nummskull", "img": "Fracalavero.png" },
  { "name": "Skillskull", "img": "Calabilidoso.png" },
  { "name": "Oh Bah Gah!", "img": "Master_Chof.png" },
  { "name": "Speedemountain", "img": "Monte_Merario.png" },
  { "name": "Shipshape Sailor", "img": "Calmarinero.png" },
  { "name": "Admirable Admiral", "img": "Almirante_Admirable.png" },
  { "name": "Sing Kong", "img": "Peter_Punki.png" },
  { "name": "Slippy", "img": "Pantuflo.png" },
  { "name": "Repossessor", "img": "Reahucio.png" },
  { "name": "Mr. Blockhead", aliases: ["Mr. Blockhead", "Mr Blockhead", "Mister Blockhead"], "img": "Radiopatio.png" },
  { "name": "Steaking", "img": "Filete_II.png" },
  { "name": "Showbonyan", "img": "Showbonyan.png" },
  { "name": "The Jawsome Kid", "img": "Tiburon_Tiburcio.png" },
  { "name": "El Sharkador", "img": "Tiburon_Jaqueton.png" },
  { "name": "Silver Lining", "img": "Capitan_Nublo.png" },
  { "name": "Originyan", "img": "originyan.png" },
  { "name": "Daikokuten", "img": "Daikokuten.png" },
  { "name": "Platinos", "img": "Platinum.png" },
  { "name": "Terminyanator", "img": "Terminyanator.png" },
  { "name": "Judgebrick", "img": "Frauduralla.png" },
  { "name": "Urnfulfilled", "img": "Insaciablo.png" },
  { "name": "Sad to the Bone", aliases: ["Sad to the Bone", "Sad 2 the Bone"], "img": "Penancio.png" },
  { "name": "Venoctobot", "img": "Venoctobot.png" },
  { "name": "Orcanos Lu Bu", "img": "Demoniorco_Lu_Bu.png" },
  { "name": "Kyubot", "img": "Kyubot.png" },
  { "name": "Ultimate Robonyan", "img": "Robonyan_Definitivo.png" },
  { "name": "King Deadward", "img": "Rey_Palmiro.png" },
  { "name": "Mumbles", "img": "Masculloso.png" },
  { "name": "Roary", "img": "Vociferio.png" },
    { name: "Chousensha", img: "Chosensha.png" },
    { name: "Monomaneking", aliases: ["Monomaneking", "Mimiking"], img: "Monomaneking.png" },
    { name: "Morigami Rex", img: "Morigami_Rex.png" },
    { name: "Zappadokia", img: "Zappadokia.png" },
    { name: "Gowin", img: "Gowin.png" }
];

let score = 0; 
let gameEnded = false; // Evita cambios una vez terminado el juego
const unlockedYoKai = new Set(); // Registro de Yo-kai desbloqueados por índice

// Normalizar la entrada del usuario (sin tildes y en minúsculas)
function normalizeString(str) {
    return str.normalize("NFD").replace(/[̀-\u036f]/g, "").toLowerCase();
}

// Crear el objeto de audio una sola vez
let getSound = new Audio("get.mp3");

// Reproducir sonido cuando se desbloquea un Yo-kai (sin solapamiento)
function playGetSound() {
    if (!getSound.paused) {
        getSound.pause(); // Detener el sonido actual si ya está reproduciéndose
        getSound.currentTime = 0; // Reiniciar el sonido al principio
    }
    getSound.play(); // Reproducir el sonido
}

// Actualizar la puntuación en formato (adivinados / totales)
function updateScoreDisplay() {
    const scoreDisplay = document.getElementById("score");
    scoreDisplay.textContent = `${score}/${yoKaiList.length}`;
}

// Verificar la respuesta del usuario
function checkAnswer() {
    if (gameEnded) return; // Si el juego ha terminado, no hacer nada

    const userAnswer = normalizeString(document.getElementById("answer-input").value.trim());

    let correctGuess = false; // Bandera para reproducir el sonido solo si hay aciertos

    yoKaiList.forEach((yoKai, index) => {
        // Normaliza todos los nombres asociados al Yo-kai
        const normalizedNames = [yoKai.name, ...(yoKai.aliases || [])].map(name => normalizeString(name));

        // Si la respuesta coincide con alguno de los nombres y no ha sido desbloqueado
        if (normalizedNames.includes(userAnswer) && !unlockedYoKai.has(index)) {
            const yoKaiImg = document.getElementById(`yo-kai${index + 1}`);
            if (yoKaiImg && yoKaiImg.src.includes("no-kai.png")) {
                yoKaiImg.src = yoKai.img; // Actualiza la imagen

                // Añadir clase para animación
                yoKaiImg.classList.add("yokai-unlocked");
                yoKaiImg.addEventListener("animationend", () => {
                    yoKaiImg.classList.remove("yokai-unlocked"); // Quitar clase tras animación
                });

                unlockedYoKai.add(index); // Marcar el Yo-kai como desbloqueado
                score++;
                correctGuess = true; // Se encontró un acierto
            }
        }
    });

    if (correctGuess) {
        playGetSound(); // Reproducir sonido solo si hubo un acierto
        updateScoreDisplay(); // Actualizar puntuación
        document.getElementById("answer-input").value = ""; // Borra la respuesta después de un acierto
    }

    checkGameEnd(); // Verifica si el juego ha terminado
}

// Verificar si el juego ha terminado (cuando se han adivinado todos los Yo-kai)
function checkGameEnd() {
    if (score === yoKaiList.length) {
        gameEnded = true;
        stopTimer(); // Detener el temporizador
        showCongratsImage(); // Mostrar imagen de "¡Felicidades!"
    }
}

function showCongratsImage() {

    // Detener temporizador
    stopTimer();

    // Obtener tiempo final mostrado
    const tiempoTotal = document.getElementById("time").textContent;

    // Sonido de victoria
    const victorySound = new Audio("congrats.mp3");
    victorySound.volume = 0.8;
    victorySound.play().catch(() => {});

    // Panel lateral
    const finalPanel = document.createElement("div");
    finalPanel.style.position = "fixed";
    finalPanel.style.top = "0";
    finalPanel.style.right = "-350px";
    finalPanel.style.width = "320px";
    finalPanel.style.height = "100%";
    finalPanel.style.backgroundColor = "#bd6000";
    finalPanel.style.color = "white";
    finalPanel.style.padding = "20px";
    finalPanel.style.boxSizing = "border-box";
    finalPanel.style.zIndex = "1000";
    finalPanel.style.fontFamily = "Arial, sans-serif";
    finalPanel.style.display = "flex";
    finalPanel.style.flexDirection = "column";
    finalPanel.style.transition = "right 0.6s ease";

    // Botón cerrar
    const closeBtn = document.createElement("div");
    closeBtn.textContent = "✖";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "15px";
    closeBtn.style.right = "15px";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.fontSize = "18px";

    closeBtn.addEventListener("click", () => {
        finalPanel.style.right = "-350px";
        setTimeout(() => finalPanel.remove(), 600);
    });

    // Título
    const title = document.createElement("h2");
    title.textContent = `Congrats! You've guessed all the Yo-kai in ${tiempoTotal}`;
    title.style.marginTop = "40px";
    title.style.marginBottom = "30px";
    title.style.fontSize = "22px";

    // Texto Twitter
    const followText = document.createElement("p");
    followText.innerHTML = `
        If you liked it, why not follow me on twitter?: 
        <a href="https://x.com/salty_baconV2" target="_blank" style="color:#4fc3ff; text-decoration:none;">
        @Salty_BaconV2
        </a>
    `;
    followText.style.fontSize = "16px";
    followText.style.marginTop = "auto";

    // Montaje
    finalPanel.appendChild(closeBtn);
    finalPanel.appendChild(title);
    finalPanel.appendChild(followText);
    document.body.appendChild(finalPanel);

    // Animación de entrada
    setTimeout(() => {
        finalPanel.style.right = "0";
    }, 50);
}

// Temporizador
let startTime;
let timerInterval;

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const currentTime = Date.now();
    const elapsedTime = currentTime - startTime;

    const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
    const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

    const formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    document.getElementById("time").textContent = formattedTime;
}

function stopTimer() {
    clearInterval(timerInterval);
}

// Manejador de evento: validación automática con "input"
document.getElementById("answer-input").addEventListener("input", checkAnswer);

// Inicializar el marcador y temporizador al cargar la página
updateScoreDisplay(); // Inicializa la puntuación en 0/total
startTimer();

window.addEventListener("beforeunload", (event) => {
    if (score > 0) { // Mostrar advertencia solo si hay progreso
        event.preventDefault();
        event.returnValue = "¿Estás seguro de que quieres salir? Se perderá todo el progreso.";
    }
});
